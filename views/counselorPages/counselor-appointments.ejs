<!DOCTYPE html>
<html lang="en" class="light-style layout-menu-fixed" data-assets-path="" data-base-url="" data-framework="django" data-template="vertical-menu-free">
<head>
  <%- include('../includes/head.ejs') %>
</head>

<body>
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <%- include('../includes/sidebar-counselor.ejs') %>

      <div class="layout-page">
        <%- include('../includes/header-counselor.ejs') %>

        <div class="content-wrapper">
          <div class="card">
            <h5 class="card-header">My Appointments</h5>
            <div class="card-body">
                <div class="table-responsive text-nowrap">
                  <div class="d-flex justify-content-between mb-3">
                    <div class="d-flex">
                      <select id="statusFilter" class="form-select me-2">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                      </select>
                      <select id="typeFilter" class="form-select me-2">
                        <option value="">All Types</option>
                        <option value="online">Online</option>
                        <option value="f2f">Face-to-Face</option>
                      </select>
                      <select id="dateFilter" class="form-select">
                        <option value="">All Dates</option>
                        <option value="today">Today</option>
                        <option value="this-week">This Week</option>
                        <option value="this-month">This Month</option>
                      </select>
                    </div>
                  </div>
                  
                  <table id="table" class="table table-bordered">
                    <thead>
                      <tr>
                        <th>Purpose</th>
                        <th>Student</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Appointment #</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% if (appointments.length > 0) { %>
                        <% appointments.forEach(appointment => { %>
                          <tr>
                            <td><%= appointment.title %></td>
                            <td><%= appointment.student_first_name %> <%= appointment.student_last_name %></td>
                            <td>
                              <%= new Date(appointment.appointment_date).toLocaleDateString('en-US', {
                                year: 'numeric', month: 'long', day: 'numeric'
                              }) %>
                            </td>
                            <td>
                              <%= new Date('1970-01-01T' + appointment.start_time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) %> 
                              to 
                              <%= new Date('1970-01-01T' + appointment.end_time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) %>

                            </td>
                            <td><%= appointment.is_online_appointment ? 'Online' : 'Face-to-Face' %></td>
                            <td><%= appointment.appointment_number %></td>
                            <td>
                              <span class="badge 
                                <%= appointment.status === 'approved' ? 'bg-label-success' : 
                                    appointment.status === 'pending' ? 'bg-label-warning' : 
                                    appointment.status === 'rejected' ? 'bg-label-danger' : 
                                    appointment.status === 'cancelled' ? 'bg-label-danger' : 
                                    appointment.status === 'completed' ? 'bg-label-success' : 
                                    'bg-label-default' %>">
                                <%= appointment.status.toUpperCase() %>
                              </span>
                            </td>
                            <td class="actions">
                              <% if (appointment.status !== 'cancelled' && appointment.status !== 'completed') { %>
                                <div class="dropdown">
                                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Actions
                                  </button>
                                  <ul class="dropdown-menu">
                                    <% if (appointment.status === 'pending') { %>
                                      <% if (appointment.turn_to_approve === 'counselor') { %>
                                        <li>
                                          <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#actionModal" onclick="setModal('Approve', '/counselor/appointments/approve/<%= appointment.id %>')">
                                            Approve Appointment
                                          </a>
                                        </li>
                                      <% } %>
                                      <li>
                                        <button 
                                          class="dropdown-item"
                                          data-bs-toggle="modal"
                                          data-bs-target="#rescheduleModal"
                                          data-appointment-id="<%= appointment.id %>"
                                          data-current-date="<%= appointment.appointment_date %>"
                                          data-counselor-id="<%= appointment.counselor_id %>">
                                          <i class="bi bi-calendar2-plus me-2"></i>Reschedule
                                        </button>
                                      </li>
                                    <% } %>
                                    <% if (appointment.status === 'pending' || appointment.status === 'approved') { %>
                                      <li>
                                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#actionModal" onclick="setModal('Cancel', '/counselor/appointments/cancel/<%= appointment.id %>')">
                                          Cancel Appointment
                                        </a>
                                      </li>
                                    <% } %>
                                    <% if (appointment.status === 'approved') { %>
                                      <li>
                                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#actionModal" onclick="setModal('Mark as Completed', '/counselor/appointments/completed/<%= appointment.id %>')">
                                          Mark as Completed
                                        </a>
                                      </li>
                                    <% } %>
                                  </ul>
                                </div>
                              <% } else { %>
                                <small class="text-muted">No actions</small>
                              <% } %>
                            </td>
                            
                            
                            
                          </tr>
                        <% }) %>
                      <% } else { %>
                        <tr><td colspan="7" class="text-center">No appointments found.</td></tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
            </div>
          </div>

          <!-- Action Confirmation Modal -->
          <div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="actionModalLabel">Confirm Action</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="actionModalBody">Are you sure you want to perform this action?</div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <a href="#" class="btn btn-primary" id="actionModalBtn">Yes, Proceed</a>
                </div>
              </div>
            </div>
          </div>


          <div class="modal fade" id="rescheduleModal" tabindex="-1" aria-labelledby="rescheduleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <form method="POST" action="/counselor/appointments/reschedule">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="rescheduleModalLabel">
                      <i class="bi bi-calendar2-plus me-1"></i> Reschedule Appointment
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <input type="hidden" name="appointment_id" id="modalAppointmentId">
                    <input type="hidden" name="counselor_id" id="modalCounselorId">
          
                    <div class="mb-3">
                      <label for="newDate" class="form-label">New Date</label>
                      <input type="date" class="form-control" id="newDate" name="new_date" required>
                    </div>
          
                    <div class="mb-3">
                      <label for="startTime" class="form-label">Start Time</label>
                      <input type="time" class="form-control" id="startTime" name="start_time" required>
                    </div>
          
                    <div class="mb-3">
                      <label for="endTime" class="form-label">End Time</label>
                      <input type="time" class="form-control" id="endTime" name="end_time" required>
                    </div>
          
                    <div id="availabilityFeedback" class="text-danger small d-none">Selected schedule is not available or invalid.</div>
                  </div>
          
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Reschedule</button>
                  </div>
                </div>
              </form>
            </div>
          </div>



          <!-- Success Modal -->
          <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content text-success">
                <div class="modal-header">
                  <h5 class="modal-title" id="successModalLabel">Success</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  Action completed successfully!
                </div>
              </div>
            </div>
          </div>

          <!-- Error Modal -->
          <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content text-danger">
                <div class="modal-header">
                  <h5 class="modal-title" id="errorModalLabel">Error</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  Failed to complete the action. Please try again.
                </div>
              </div>
            </div>
          </div>

          <div class="content-backdrop fade"></div>
        </div>

        <%- include('../includes/footer.ejs') %>
      </div>
    </div>
    <div class="layout-overlay layout-menu-toggle"></div>
    <div class="drag-target"></div>
  </div>

  <%- include('../includes/scripts.ejs') %>

  <script>

      flatpickr("#newDate", {
        dateFormat: "Y-m-d",  // Format as yyyy-mm-dd
        minDate: "today",     // Prevent selection of past dates
      });


    // Sets the modal for actions like Approve / Cancel / Mark as Completed
    function setModal(actionType, actionLink) {
      document.getElementById('actionModalLabel').textContent = `Confirm ${actionType}`;
      document.getElementById('actionModalBody').textContent = `Are you sure you want to ${actionType.toLowerCase()} this appointment?`;
      document.getElementById('actionModalBtn').setAttribute('href', actionLink);
    }

    $(document).ready(function () {
      var table = $('#table').DataTable({
        "order": [[2, 'desc']], // Sort by date column (index 2)
        "columnDefs": [
          { "targets": 2, "type": "date" }, // Date column (index 2)
        ]
      });

      let minDate, maxDate;

      // Custom filtering function for date range
      $.fn.dataTable.ext.search.push(
        function (settings, data, dataIndex) {
          if (!minDate || !maxDate) return true;

          var appointmentDate = new Date(data[2]); // Column index 2 (date column)
          return appointmentDate >= minDate && appointmentDate <= maxDate;
        }
      );

      // Filter by Status
      $('#statusFilter').on('change', function () {
        table.column(5).search(this.value).draw(); // Column index 5 (status)
      });

      // Filter by Type
      $('#typeFilter').on('change', function () {
        if (this.value === 'online') {
          table.column(3).search('Online').draw(); // Column index 3 (type)
        } else if (this.value === 'f2f') {
          table.column(3).search('Face-to-Face').draw();
        } else {
          table.column(3).search('').draw();
        }
      });

      // Filter by Date Range
      $('#dateFilter').on('change', function () {
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        var selected = $(this).val();

        if (selected === 'today') {
          minDate = new Date(today);
          maxDate = new Date(today);
          maxDate.setHours(23, 59, 59, 999);
        } else if (selected === 'this-week') {
          var day = today.getDay(); // 0 (Sun) to 6 (Sat)
          var diffToMonday = today.getDate() - day + (day === 0 ? -6 : 1); // Get Monday
          minDate = new Date(today.setDate(diffToMonday));
          minDate.setHours(0, 0, 0, 0);
          maxDate = new Date(minDate);
          maxDate.setDate(maxDate.getDate() + 6);
          maxDate.setHours(23, 59, 59, 999);
        } else if (selected === 'this-month') {
          minDate = new Date(today.getFullYear(), today.getMonth(), 1);
          maxDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          maxDate.setHours(23, 59, 59, 999);
        } else {
          minDate = null;
          maxDate = null;
        }

        table.draw(); // Redraw with new date filter
      });
    });


    document.querySelector('table').addEventListener('click', function (e) {
      if (e.target && e.target.classList.contains('dropdown-item') && e.target.dataset.bsTarget === '#rescheduleModal') {
        const appointmentId = e.target.dataset.appointmentId;
        console.log("APPOINTMENT ID: " + appointmentId);
        document.getElementById('modalAppointmentId').value = appointmentId;
        // If needed, set the date or other fields
      }
    });


  </script>
</body>
</html>