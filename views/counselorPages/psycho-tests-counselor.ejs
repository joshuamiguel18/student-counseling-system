<!DOCTYPE html>
<html lang="en" class="light-style layout-menu-fixed" data-assets-path="" data-base-url="" data-framework="django" data-template="vertical-menu-free">
<head>
  <%- include('../includes/head.ejs') %>
  <title><%= title %></title>
</head>

<body>
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <%- include('../includes/sidebar-counselor.ejs') %>

      <div class="layout-page">
        <%- include('../includes/header-counselor.ejs') %>

        <div class="content-wrapper">
          <div class="card">
            <h5 class="card-header">Psychological Tests</h5>
            <div class="card-body">
                <div class="table-responsive text-nowrap">
                  <div class="d-flex justify-content-between mb-3">
                    <div class="d-flex">
                      <select id="statusFilter" class="form-select me-2">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                      </select>
                      <select id="typeFilter" class="form-select me-2">
                        <option value="">All Types</option>
                        <option value="online">Online</option>
                        <option value="offline">Offline</option>
                      </select>
                      <select id="dateFilter" class="form-select">
                        <option value="">All Dates</option>
                        <option value="today">Today</option>
                        <option value="this-week">This Week</option>
                        <option value="this-month">This Month</option>
                      </select>
                    </div>
                  </div>
                  
                  <table id="testsTable" class="table table-bordered">
                    <thead>
                      <tr>
                        <th>Test Title</th>
                        <th>Student</th>
                        <th>Test Date</th>
                        <th>Type</th>
                        <th>Test #</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% if (psychoTests.length > 0) { %>
                        <% psychoTests.forEach(test => { %>
                          <tr>
                            <td><%= test.test_title %></td>
                            <td><%= test.student_first_name %> <%= test.student_last_name %></td>
                            <td><%= new Date(test.test_date).toLocaleString() %></td>
                            <td><%= test.is_online_test ? 'Online' : 'Offline' %></td>
                            <td><%= test.test_number %></td>
                            <td>
                              <span class="badge 
                                <%= test.status === 'completed' ? 'bg-label-success' : 
                                    test.status === 'in_progress' ? 'bg-label-primary' :
                                    test.status === 'pending' ? 'bg-label-warning' : 
                                    test.status === 'cancelled' ? 'bg-label-danger' : 
                                    'bg-label-default' %>">
                                <%= test.status.replace('_', ' ').toUpperCase() %>
                              </span>
                            </td>
                            <td class="actions">
                              <% if (test.status !== 'cancelled' && test.status !== 'completed') { %>
                                <a href="#" data-bs-toggle="modal" data-bs-target="#actionModal" 
                                   onclick="setModal('Start Test', '/counselor/psycho-tests/start/<%= test.id %>')">
                                  <i class="bi bi-play-circle-fill text-primary" title="Start Test"></i>
                                </a>
                                <a href="#" data-bs-toggle="modal" data-bs-target="#actionModal" 
                                   onclick="setModal('Cancel', '/counselor/psycho-tests/cancel/<%= test.id %>')">
                                  <i class="bi bi-x-circle-fill text-danger" title="Cancel"></i>
                                </a>
                              <% } %>
                              <% if (test.is_online_test && test.status === 'in_progress') { %>
                                <a href="/counselor/psycho-tests/<%= test.id %>/conduct">
                                  <i class="bi bi-pencil-square text-info" title="Conduct Test"></i>
                                </a>
                              <% } %>
                              <% if (test.status === 'completed') { %>
                                <a href="/counselor/psycho-tests/<%= test.id %>/results">
                                  <i class="bi bi-file-earmark-text-fill text-success" title="View Results"></i>
                                </a>
                              <% } %>
                            </td>
                          </tr>
                        <% }) %>
                      <% } else { %>
                        <tr><td colspan="7" class="text-center">No psychological tests found.</td></tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
            </div>
          </div>

          <!-- Action Confirmation Modal -->
          <div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="actionModalLabel">Confirm Action</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="actionModalBody">Are you sure you want to perform this action?</div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <a href="#" class="btn btn-primary" id="actionModalBtn">Yes, Proceed</a>
                </div>
              </div>
            </div>
          </div>

          <div class="content-backdrop fade"></div>
        </div>

        <%- include('../includes/footer.ejs') %>
      </div>
    </div>
    <div class="layout-overlay layout-menu-toggle"></div>
    <div class="drag-target"></div>
  </div>

  <%- include('../includes/scripts.ejs') %>

  <script>
    // Sets the modal for actions
    function setModal(actionType, actionLink) {
      document.getElementById('actionModalLabel').textContent = `Confirm ${actionType}`;
      document.getElementById('actionModalBody').textContent = `Are you sure you want to ${actionType.toLowerCase()} this test?`;
      document.getElementById('actionModalBtn').setAttribute('href', actionLink);
    }

    $(document).ready(function () {
      var table = $('#testsTable').DataTable({
        "order": [[2, 'desc']], // Sort by test date column (index 2)
        "columnDefs": [
          { "targets": 2, "type": "date" }, // Test date column (index 2)
        ]
      });

      let minDate, maxDate;

      // Custom filtering function for date range
      $.fn.dataTable.ext.search.push(
        function (settings, data, dataIndex) {
          if (!minDate || !maxDate) return true;

          var testDate = new Date(data[2]); // Column index 2 (test date)
          return testDate >= minDate && testDate <= maxDate;
        }
      );

      // Filter by Status
      $('#statusFilter').on('change', function () {
        table.column(5).search(this.value).draw(); // Column index 5 (status)
      });

      // Filter by Type
      $('#typeFilter').on('change', function () {
        if (this.value === 'online') {
          table.column(3).search('Online').draw(); // Column index 3 (type)
        } else if (this.value === 'offline') {
          table.column(3).search('Offline').draw();
        } else {
          table.column(3).search('').draw();
        }
      });

      // Filter by Date Range
      $('#dateFilter').on('change', function () {
        var today = new Date();
        today.setHours(0, 0, 0, 0);
        var selected = $(this).val();

        if (selected === 'today') {
          minDate = new Date(today);
          maxDate = new Date(today);
          maxDate.setHours(23, 59, 59, 999);
        } else if (selected === 'this-week') {
          var day = today.getDay();
          var diffToMonday = today.getDate() - day + (day === 0 ? -6 : 1);
          minDate = new Date(today.setDate(diffToMonday));
          minDate.setHours(0, 0, 0, 0);
          maxDate = new Date(minDate);
          maxDate.setDate(maxDate.getDate() + 6);
          maxDate.setHours(23, 59, 59, 999);
        } else if (selected === 'this-month') {
          minDate = new Date(today.getFullYear(), today.getMonth(), 1);
          maxDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          maxDate.setHours(23, 59, 59, 999);
        } else {
          minDate = null;
          maxDate = null;
        }

        table.draw();
      });
    });
  </script>
</body>
</html>